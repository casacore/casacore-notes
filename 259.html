<?xml version="1.0" encoding="iso-8859-1" ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" 
"http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd" > 
<html xmlns="http://www.w3.org/1999/xhtml"  
> 
<head><title>NOTE 259: libpyrap, casacore-python converters</title> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<!-- xhtml,mathml,fn-in,css2,css-in,html --> 
<meta name="src" content="259.tex" /> 
<meta name="date" content="2015-07-30 09:23:00" /> 
 
<style type="text/css"> 
<!--  
 
/* start css.sty */  
.cmex-10{font-size:90%;}  
.cmr-10{font-size:90%;}  
.cmr-10x-x-109{}  
.cmbsy-10x-x-109{font-weight: bold;}  
.cmbsy-10x-x-109{font-weight: bold;}  
.cmbsy-10x-x-109{font-weight: bold;}  
.cmbsy-8{font-size:72%;font-weight: bold;}  
.cmbsy-8{font-weight: bold;}  
.cmbsy-8{font-weight: bold;}  
.cmbsy-6{font-size:54%;font-weight: bold;}  
.cmbsy-6{font-weight: bold;}  
.cmbsy-6{font-weight: bold;}  
.cmr-8{font-size:72%;}  
.cmr-6{font-size:54%;}  
.cmmi-10x-x-109{font-style: italic;}  
.cmmi-8{font-size:72%;font-style: italic;}  
.cmmi-6{font-size:54%;font-style: italic;}  
.cmsy-10x-x-109{}  
.cmsy-8{font-size:72%;}  
.cmsy-6{font-size:54%;}  
.cmr-17{font-size:154%;}  
.cmr-12{font-size:109%;}  
.cmbx-10{font-size:90%; font-weight: bold;}  
.cmtt-10x-x-109{font-family: monospace;}  
p.noindent { text-indent: 0em }  
td p.noindent { text-indent: 0em; margin-top:0em; }  
p.nopar { text-indent: 0em; }  
p.indent{ text-indent: 1.5em }  
@media print {div.crosslinks {visibility:hidden;}}  
a img { border-top: 0; border-left: 0; border-right: 0; }  
center { margin-top:1em; margin-bottom:1em; }  
td center { margin-top:0em; margin-bottom:0em; }  
.Canvas { position:relative; }  
math { text-indent: 0em; }  
li p.indent { text-indent: 0em }  
li p:first-child{ margin-top:0em; }  
li p:last-child, li div:last-child { margin-bottom:0.5em; }  
li p~ul:last-child, li p~ol:last-child{ margin-bottom:0.5em; }  
ul.itemize1 {list-style-type: none;}  
ul.itemize1 li.itemize:before { display: marker; marker-offset: 0.5em; content: "&#x2219; " }  
ul.itemize2 {list-style-type: none;}  
ul.itemize2 li.itemize:before { display: marker; marker-offset: 0.5em; content: "\protect \protect \edef OT1{OT1}\let \enc @update \relax \protect \edef cmr{cmr}\protect \edef m{m}\protect \edef n{n}\protect \afterassignment \edef 10.95{360}\afterassignment \edef 13.6pt{13.6pt}\edef 1{}\let 1\def \size @update {\baselineskip 13.6pt\relax \baselineskip 1\baselineskip \normalbaselineskip \baselineskip \setbox \strutbox \hbox {\vrule height.7\baselineskip depth.3\baselineskip width\z @ }\let \size @update \relax }\xdef \OT 1/cmr/m/n/10.95 {\OT 1/cmr/m/n/10.95 }\OT 1/cmr/m/n/10.95 \size @update \enc @update \ignorespaces \relax \protect \relax \protect \edef m{bx}\protect \afterassignment \edef 10.95{360}\afterassignment \edef 13.6pt{13.6pt}\edef 1{}\let 1\def \size @update {\baselineskip 13.6pt\relax \baselineskip 1\baselineskip \normalbaselineskip \baselineskip \setbox \strutbox \hbox {\vrule height.7\baselineskip depth.3\baselineskip width\z @ }\let \size @update \relax }\xdef \OT 1/cmr/m/n/10.95 {\OT 1/cmr/m/n/10.95 }\OT 1/cmr/m/n/10.95 \size @update \enc @update \OT 1\textendash " }  
ul.itemize3 {list-style-type: none;}  
ul.itemize3 li.itemize:before { display: marker; marker-offset: 0.5em; content: "* " }  
.enumerate1 {list-style-type:decimal;}  
.enumerate2 {list-style-type:lower-alpha;}  
.enumerate3 {list-style-type:lower-roman;}  
.enumerate4 {list-style-type:upper-alpha;}  
div.newtheorem { margin-bottom: 2em; margin-top: 2em;}  
.obeylines-h,.obeylines-v {white-space: nowrap; }  
div.obeylines-v p { margin-top:0; margin-bottom:0; }  
.overline{ text-decoration:overline; }  
.overline img{ border-top: 1px solid black; }  
td.displaylines {text-align:center; white-space:nowrap;}  
.centerline {text-align:center;}  
.rightline {text-align:right;}  
div.verbatim {font-family: monospace; white-space: nowrap; text-align:left; clear:both; }  
.fbox {padding-left:3.0pt; padding-right:3.0pt; text-indent:0pt; border:solid black 0.4pt; }  
div.fbox {display:table}  
div.center div.fbox {text-align:center; clear:both; padding-left:3.0pt; padding-right:3.0pt; text-indent:0pt; border:solid black 0.4pt; }  
div.minipage{width:100%;}  
div.center, div.center div.center {text-align: center; margin-left:1em; margin-right:1em;}  
div.center div {text-align: left;}  
div.flushright, div.flushright div.flushright {text-align: right;}  
div.flushright div {text-align: left;}  
div.flushleft {text-align: left;}  
.underline{ text-decoration:underline; }  
.underline img{ border-bottom: 1px solid black; margin-bottom:1pt; }  
.framebox-c, .framebox-l, .framebox-r { padding-left:3.0pt; padding-right:3.0pt; text-indent:0pt; border:solid black 0.4pt; }  
.framebox-c {text-align:center;}  
.framebox-l {text-align:left;}  
.framebox-r {text-align:right;}  
span.thank-mark{ vertical-align: super }  
span.footnote-mark sup.textsuperscript, span.footnote-mark a sup.textsuperscript{ font-size:80%; }  
div.footnotes{border-top:solid 1px black; border-bottom:solid 1px black; padding-bottom:1ex; padding-top:0.5ex; margin-right:15%; margin-top:2ex; font-style:italic; font-size:85%;}  
div.footnotes p{margin-top:0; margin-bottom:0; text-indent:0;}  
div.tabular, div.center div.tabular {text-align: center; margin-top:0.5em; margin-bottom:0.5em; }  
table.tabular td p{margin-top:0em;}  
table.tabular {margin-left: auto; margin-right: auto;}  
td p:first-child{ margin-top:0em; }  
td p:last-child{ margin-bottom:0em; }  
div.td00{ margin-left:0pt; margin-right:0pt; }  
div.td01{ margin-left:0pt; margin-right:5pt; }  
div.td10{ margin-left:5pt; margin-right:0pt; }  
div.td11{ margin-left:5pt; margin-right:5pt; }  
table[rules] {border-left:solid black 0.4pt; border-right:solid black 0.4pt; }  
td.td00{ padding-left:0pt; padding-right:0pt; }  
td.td01{ padding-left:0pt; padding-right:5pt; }  
td.td10{ padding-left:5pt; padding-right:0pt; }  
td.td11{ padding-left:5pt; padding-right:5pt; }  
table[rules] {border-left:solid black 0.4pt; border-right:solid black 0.4pt; }  
.hline hr, .cline hr{ height : 1px; margin:0px; }  
.tabbing-right {text-align:right;}  
span.TEX {letter-spacing: -0.125em; }  
span.TEX span.E{ position:relative;top:0.5ex;left:-0.0417em;}  
a span.TEX span.E {text-decoration: none; }  
span.LATEX span.A{ position:relative; top:-0.5ex; left:-0.4em; font-size:85%;}  
span.LATEX span.TEX{ position:relative; left: -0.4em; }  
div.float, div.figure {margin-left: auto; margin-right: auto;}  
div.float img {text-align:center;}  
div.figure img {text-align:center;}  
.marginpar {width:20%; float:right; text-align:left; margin-left:auto; margin-top:0.5em; font-size:85%; text-decoration:underline;}  
.marginpar p{margin-top:0.4em; margin-bottom:0.4em;}  
.equation td{text-align:center; vertical-align:middle; }  
td.eq-no{ width:5%; }  
table.equation { width:100%; }  
div.math-display, div.par-math-display{text-align:center;}  
mtr.hline mtd{ border-bottom:black solid 1px; padding-top:2px; padding-bottom:0em; }  
mtr.hline mtd mo{ display:none }  
math .texttt { font-family: monospace; }  
math .textit { font-style: italic; }  
math .textsl { font-style: oblique; }  
math .textsf { font-family: sans-serif; }  
math .textbf { font-weight: bold; }  
mo.MathClass-op + mi{margin-left:0.3em}  
mi + mo.MathClass-op{margin-left:0.3em}  
math mstyle[mathvariant="bold"] mi { font-weight: bold; font-style: normal; }  
math mstyle[mathvariant="normal"] mi { font-weight: normal; font-style: normal; }  
.partToc a, .partToc, .likepartToc a, .likepartToc {line-height: 200%; font-weight:bold; font-size:110%;}  
.index-item, .index-subitem, .index-subsubitem {display:block}  
div.caption {text-indent:-2em; margin-left:3em; margin-right:1em; text-align:left;}  
div.caption span.id{font-weight: bold; white-space: nowrap; }  
h1.partHead{text-align: center}  
p.bibitem { text-indent: -2em; margin-left: 2em; margin-top:0.6em; margin-bottom:0.6em; }  
p.bibitem-p { text-indent: 0em; margin-left: 2em; margin-top:0.6em; margin-bottom:0.6em; }  
.paragraphHead, .likeparagraphHead { margin-top:2em; font-weight: bold;}  
.subparagraphHead, .likesubparagraphHead { font-weight: bold;}  
.quote {margin-bottom:0.25em; margin-top:0.25em; margin-left:1em; margin-right:1em; text-align:justify;}  
.verse{white-space:nowrap; margin-left:2em}  
div.maketitle {text-align:center;}  
h2.titleHead{text-align:center;}  
div.maketitle{ margin-bottom: 2em; }  
div.author, div.date {text-align:center;}  
div.thanks{text-align:left; margin-left:10%; font-size:85%; font-style:italic; }  
.quotation {margin-bottom:0.25em; margin-top:0.25em; margin-left:1em; }  
.abstract p {margin-left:5%; margin-right:5%;}  
div.abstract {width:100%;}  
/* end css.sty */  
 
 
--> 
</style> 
</head><body 
>
   <div class="maketitle">
                                                                     

                                                                     
                                                                     

                                                                     

<h2 class="titleHead">NOTE 259: libpyrap, casacore-python converters</h2>
<div class="author" ><span 
class="cmr-12">Ger van Diepen, ASTRON Dwingeloo</span></div><br />
<div class="date" ><span 
class="cmr-12">November 10, 2006</span></div>
   </div><div 
class="abstract" 
>
<div class="center" 
>
<!--l. 15--><p class="noindent" >
</p><!--l. 15--><p class="noindent" ><span 
class="cmbx-10">Abstract</span></p></div>
     <!--l. 16--><p class="indent" >    <span 
class="cmr-10">pyrap is a Python binding to casacore classes using Boost.Python.</span>
     <span 
class="cmr-10">It consists of a set of standard converters and bindings to the classes.</span>
     <span 
class="cmr-10">As much as possible the bindings are the same as in glish.</span>
</p>
</div> <a 
href="259.pdf" >A pdf version of this note is available.</a>
   <h3 class="likesectionHead"><a 
 id="x1-1000"></a>Contents</h3>
   <div class="tableofcontents">
   <span class="sectionToc" >1 <a 
href="#x1-20001" id="QQ2-1-2">Introduction</a></span>
<br />   <span class="sectionToc" >2 <a 
href="#x1-30002" id="QQ2-1-3">Converters</a></span>
<br />   &#x00A0;<span class="subsectionToc" >2.1 <a 
href="#x1-40002.1" id="QQ2-1-4">Array conversion to/from numpy and numarray</a></span>
<br />   <span class="sectionToc" >3 <a 
href="#x1-50003" id="QQ2-1-5">Class wrappers</a></span>
<br />   &#x00A0;<span class="subsectionToc" >3.1 <a 
href="#x1-60003.1" id="QQ2-1-6">More complicated wrappers</a></span>
<br />   &#x00A0;<span class="subsectionToc" >3.2 <a 
href="#x1-70003.2" id="QQ2-1-7">Combining multiple classes</a></span>
<br />   <span class="sectionToc" >4 <a 
href="#x1-80004" id="QQ2-1-8">Python specifics</a></span>
<br />   <span class="sectionToc" >5 <a 
href="#x1-90005" id="QQ2-1-9">Building pyrap</a></span>
   </div>
                                                                     

                                                                     
   <h3 class="sectionHead"><span class="titlemark">1   </span> <a 
 id="x1-20001"></a>Introduction</h3>
<!--l. 5--><p class="noindent" >Since long glish bindings to the Casacore system have been in place. Quite
recently Python bindings have been created in the general casapy framework
using tools like CCMTools, Xerces, Xalan, and IDL. Albeit very flexible, it is
quite complicated and it is not straightforward to build on other systems than
RedHat and OS-X.
</p><!--l. 11--><p class="indent" >   Therefore an attempt has been made to make a simpler Python binding using
<a 
href="http://www.boost.org/libs/python/doc" >Boost.Python</a>. This proved to be very easy and succesful. The binding consists of
two parts: </p>
     <ul class="itemize1">
     <li class="itemize">Converters to translate objects between Python and C++.
     </li>
     <li class="itemize">Class wrappers to map a C++ class and its functions to Python.</li></ul>
<!--l. 19--><p class="noindent" >The Python numarray and numpy (version 1.0 or higher) packages are supported. At
build time one can choose which ones should be used.
</p><!--l. 22--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">2   </span> <a 
 id="x1-30002"></a>Converters</h3>
<!--l. 23--><p class="noindent" >Boost.Python offers a nice way to convert objects to and from Python. Ralf W.
Grosse-Kunstleve ¡rwgk@yahoo.com¿ of <a 
href="http://www.lbl.gov" >Lawrence Berkeley National Laboratory</a>
has built converters for standard STL containers. This has been extended to
convert to/from other objects. <br 
class="newline" />The following C++ objects are currently supported: </p>
     <ul class="itemize1">
     <li class="itemize">scalars (bool, integer, real, complex)
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">std::string</span>
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">casa::String</span>
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">std::vector&#x003C;T&#x003E;</span>
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">casa::Vector&#x003C;T&#x003E;</span>
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">casa::IPosition</span>
                                                                     

                                                                     
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">casa::Record</span>
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">casa::ValueHolder</span>
     </li>
     <li class="itemize">exceptions (<span 
class="cmtt-10x-x-109">casa::IterError </span>and <span 
class="cmtt-10x-x-109">std::exception</span>)</li></ul>
<!--l. 40--><p class="noindent" >These C++ objects can usually be created from several types of Python objects and
are converted to a specific Python object. </p>
     <ul class="itemize1">
     <li class="itemize">A vector or IPosition object is converted to a Python list. <br 
class="newline" />It can be constructed from the following Python objects:
          <ul class="itemize2">
          <li class="itemize">scalar
          </li>
          <li class="itemize">list or tuple
          </li>
          <li class="itemize">numarray scalar or 1-dim array
          </li>
          <li class="itemize">numpy scalar or 1-dim array</li></ul>
     <!--l. 52--><p class="noindent" >Note that a list or tuple of arbitrary objects can be given. For example, it is
     possible to get a <span 
class="cmtt-10x-x-109">Vector&#x003C;TableProxy&#x003E; </span>from Python.
     </p></li>
     <li class="itemize">A casa::Record is mapped to a Python dict.
     </li>
     <li class="itemize">Every C++ exception is mapped to a Python <span 
class="cmtt-10x-x-109">RunTimeError </span>exception.
     However, <span 
class="cmtt-10x-x-109">casa::IterError </span>is special and is mapped to an end-of-iteration
     exception (<span 
class="cmtt-10x-x-109">StopIteration</span>) in Python.
     </li>
     <li class="itemize">A casa::ValueHolder is a special Casacore object that can hold a record or a
     scalar value or n-dim array of many types (bool, numeric, string). It is
     meant to conceal the actual type which is useful in functions that
     can accept a variety of types (like <span 
class="cmtt-10x-x-109">getcell </span>in the table binding).
     <br 
class="newline" />Converting a ValueHolder to Python creates the appropriate Python scalar,
     array, or dict object. When converting from Python to ValueHolder,
     the appropriate internal ValueHolder value is constructed; a list,
     tuple, and array object are converted to an Casacore array in the
     ValueHolder.</li></ul>
                                                                     

                                                                     
<!--l. 72--><p class="noindent" >It means there is no direct Array conversion to/from Python. A ValueHolder
object is always needed to do the conversion. Note that this is a cheap
operation, as it uses Array reference semantics. ValueHolder has functions to
convert between types, so one can get out an Array with the required
type.
</p><!--l. 78--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">2.1   </span> <a 
 id="x1-40002.1"></a>Array conversion to/from numpy and numarray</h4>
<!--l. 79--><p class="noindent" >Casacore arrays are kept in Fortran-order, while Python arrays are kept in
C-order. It was felt that the Python interface should be as pythonic as
possible. Therefore it was decided that the array axes are reversed when
converting to/from Python. The values in an IPosition object (describing
shape or position) are also reversed when converting to/from Python.
<br 
class="newline" />Note that although numarray and numpy have Fortran-array provisions by
setting the appropriate internal strides, they do not really support them. When
adding, for instance, the scalar value 0 to a Fortran-array, the result
is a transposed version of the original (which can be a quite expensive
operation).
</p><!--l. 91--><p class="indent" >   A function binding could be such that shape information is passed via, say, a
<span 
class="cmtt-10x-x-109">Record </span>and not via an <span 
class="cmtt-10x-x-109">IPosition </span>object. In that case its values are
not reversed automatically, so the programmer is responsible for doing
it.
</p><!--l. 97--><p class="indent" >   An Casacore array is returned to Python as an array object containing a copy
of the Casacore array data. If pyrap has been built with support for only one
Python array package (numpy or numarray), it is clear which array type is
returned. If support for both packages has been built in, by default an array of
the imported package is returned. If both or no array packages have been
imported, a numpy array is returned. <br 
class="newline" />Note that there is no support for the old Numeric package.
</p><!--l. 106--><p class="indent" >   An Casacore array constructed from a Python array is regarded as a
temporary object. So if possible, the Casacore array refers to the Python array
data to avoid a needless copy. This is not possible if the element size in Python
differs from Casacore. It is also not possible if the Python array is not
contiguous (or not aligned or byte swapped). In those cases a copy is
made.
</p><!--l. 113--><p class="indent" >   A few more numarray/numpy specific issues are dealt with: </p>
     <ul class="itemize1">
     <li class="itemize">An  empty  N-dim  Casacore  array  (i.e.  an  array  containing  no
     elements)  is  returned  as  an  empty  N-dim  Python  array.  If  the
     dimensionality  is  zero,  it  is  returned  as  an  empty  1-dim  array,  to
     prevent numarray/numpy from treating it as a scalar value.
                                                                     

                                                                     
     </li>
     <li class="itemize">In  numarray  <span 
class="cmtt-10x-x-109">array() </span>results  in  <span 
class="cmtt-10x-x-109">Py</span><span 
class="cmtt-10x-x-109">_None</span>.  This  is  accepted  by  the
     converters as an empty 1-dim array.
     </li>
     <li class="itemize">Empty arrays can be constructed in Python using empty lists. For
     example, <span 
class="cmtt-10x-x-109">array([[]]) </span>results in an empty 2-dim array. The converters
     accept such empty N-dim Python arrays. The type of an empty array
     is set to Int by numarray and to Double by numpy.
     </li>
     <li class="itemize">Because the type of an empty Python array cannot easily be set, the
     converters can convert an empty integer or real array to any type.
     </li>
     <li class="itemize">The converters accept a numpy string array. However, it is returned
     to Python as the special <span 
class="cmtt-10x-x-109">dict </span>object described above.</li></ul>
<!--l. 131--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">3   </span> <a 
 id="x1-50003"></a>Class wrappers</h3>
<!--l. 132--><p class="noindent" >Usually a binding to an existing Proxy class is made, for example <span 
class="cmtt-10x-x-109">TableProxy</span>,
which should be the same class used in the glish-binding. For a simple binding,
only some simple C++ code has to be written in pyrap/apps/pyxx/pyxx.cc,
where XX is the name of the class.
                                                                     

                                                                     
</p>
   <div class="verbatim" id="verbatim-1">
//&#x00A0;Include&#x00A0;files&#x00A0;for&#x00A0;converters&#x00A0;being&#x00A0;used.
&#x00A0;<br />#include&#x00A0;&#x003C;pyrap/Converters/PycExcp.h&#x003E;
&#x00A0;<br />#include&#x00A0;&#x003C;pyrap/Converters/PycBasicData.h&#x003E;
&#x00A0;<br />#include&#x00A0;&#x003C;pyrap/Converters/PycRecord.h&#x003E;
&#x00A0;<br />//&#x00A0;Include&#x00A0;file&#x00A0;for&#x00A0;boost&#x00A0;python.
&#x00A0;<br />#include&#x00A0;&#x003C;boost/python.hpp&#x003E;
&#x00A0;<br />
&#x00A0;<br />using&#x00A0;namespace&#x00A0;boost::python;
&#x00A0;<br />
&#x00A0;<br />namespace&#x00A0;casa&#x00A0;{&#x00A0;namespace&#x00A0;pyrap&#x00A0;{
&#x00A0;<br />&#x00A0;&#x00A0;void&#x00A0;wrap_xx()
&#x00A0;<br />&#x00A0;&#x00A0;{
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;//&#x00A0;Define&#x00A0;the&#x00A0;class;&#x00A0;"xx"&#x00A0;is&#x00A0;the&#x00A0;class&#x00A0;name&#x00A0;in&#x00A0;Python.
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;class_&#x003C;XX&#x003E;&#x00A0;("xx")
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;//&#x00A0;Define&#x00A0;the&#x00A0;constructor.
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;//&#x00A0;Multiple&#x00A0;constructors&#x00A0;can&#x00A0;be&#x00A0;defined.
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;//&#x00A0;They&#x00A0;have&#x00A0;to&#x00A0;have&#x00A0;different&#x00A0;number&#x00A0;of&#x00A0;arguments.
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;.def&#x00A0;(init&#x003C;&#x003E;())
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;//&#x00A0;Add&#x00A0;a&#x00A0;.def&#x00A0;line&#x00A0;for&#x00A0;each&#x00A0;function&#x00A0;to&#x00A0;be&#x00A0;wrapped.
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;//&#x00A0;An&#x00A0;arg&#x00A0;line&#x00A0;should&#x00A0;be&#x00A0;added&#x00A0;for&#x00A0;each&#x00A0;argument&#x00A0;giving
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;//&#x00A0;its&#x00A0;name&#x00A0;and&#x00A0;possibly&#x00A0;default&#x00A0;value.
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;.def&#x00A0;("func1",&#x00A0;&amp;XX::func1,
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;(boost::python::arg("arg1"),
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;boost::python::arg("arg2")=0))
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;;
&#x00A0;<br />&#x00A0;&#x00A0;}
&#x00A0;<br />}}
&#x00A0;<br />
&#x00A0;<br />BOOST_PYTHON_MODULE(_xx)
&#x00A0;<br />{
&#x00A0;<br />&#x00A0;&#x00A0;//&#x00A0;Register&#x00A0;the&#x00A0;conversion&#x00A0;functions.
&#x00A0;<br />&#x00A0;&#x00A0;casa::pyrap::register_convert_excp();
&#x00A0;<br />&#x00A0;&#x00A0;casa::pyrap::register_convert_basicdata();
&#x00A0;<br />&#x00A0;&#x00A0;casa::pyrap::register_convert_casa_record();
&#x00A0;<br />&#x00A0;&#x00A0;//&#x00A0;Initialize&#x00A0;the&#x00A0;wrapping.
&#x00A0;<br />&#x00A0;&#x00A0;casa::pyrap::wrap_xx();
&#x00A0;<br />}
</div>
<!--l. 175--><p class="nopar" > Python requires for each package a file <span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_init</span><span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_.py</span>, so such an empty file
should be created as well.
                                                                     

                                                                     
</p><!--l. 179--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">3.1   </span> <a 
 id="x1-60003.1"></a>More complicated wrappers</h4>
<!--l. 180--><p class="noindent" >Sometimes a C++ function cannot be wrapped directly, because the argument
order needs to be changed or because some extra Python checks are
necessary. In such a case the class needs to be implemented in Python itself.
<br 
class="newline" />The C++ wrapped class name needs to get a different name, usually by
preceeding it with an underscore like:
                                                                     

                                                                     
</p>
   <div class="verbatim" id="verbatim-2">
&#x00A0;&#x00A0;&#x00A0;&#x00A0;class_&#x003C;XX&#x003E;&#x00A0;("_xx")
</div>
<!--l. 188--><p class="nopar" > The Python class should be derived from it and implement the constructor by
calling the constructor of _xx.
                                                                     

                                                                     
</p>
   <div class="verbatim" id="verbatim-3">
class&#x00A0;xx(_xx):
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;def&#x00A0;__init__(self):
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;_xx.__init__(self)
</div>
<!--l. 195--><p class="nopar" > Now <span 
class="cmtt-10x-x-109">xx </span>inherits all functions from <span 
class="cmtt-10x-x-109">_xx</span>. The required function can be written in
Python like
                                                                     

                                                                     
</p>
   <div class="verbatim" id="verbatim-4">
&#x00A0;&#x00A0;&#x00A0;&#x00A0;def&#x00A0;func1&#x00A0;(self,&#x00A0;arg1,&#x00A0;arg2):
&#x00A0;<br />&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;return&#x00A0;self._func1&#x00A0;(arg2,&#x00A0;arg1);
</div>
<!--l. 201--><p class="nopar" > Note that in the wrapper the function name also needs to be preceeded by an
underscore to make it different.
</p><!--l. 205--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">3.2   </span> <a 
 id="x1-70003.2"></a>Combining multiple classes</h4>
<!--l. 206--><p class="noindent" >Sometimes one wants to combine multiple classes in a package. A example is
package <span 
class="cmtt-10x-x-109">pycasatable </span>which contains the classes <span 
class="cmtt-10x-x-109">table</span>, <span 
class="cmtt-10x-x-109">tablecolumn</span>, <span 
class="cmtt-10x-x-109">tablerow</span>,
<span 
class="cmtt-10x-x-109">tableiter</span>, and <span 
class="cmtt-10x-x-109">tableindex</span>. One is referred to the code of this package (in
code/pyrap/apps/pycasatable) to see how to do it.
</p><!--l. 213--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">4   </span> <a 
 id="x1-80004"></a>Python specifics</h3>
<!--l. 214--><p class="noindent" >Besides an array being in C-order, there are a few more Python specific issues.
</p>
     <ul class="itemize1">
     <li class="itemize">Indexing starts at 0 (vs. 1 in glish).
     </li>
     <li class="itemize">The end value in a range like <span 
class="cmtt-10x-x-109">[10:20] </span>is exclusive (vs. inclusive in
     glish). Furthermore Python supports a step and reversed ranges.
     </li>
     <li class="itemize">Where useful, the function <span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_str</span><span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_ </span>should be added giving the name
     of the object. This function is used when printing an object.
     </li>
     <li class="itemize">Where useful, the functions <span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_len</span><span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_</span>, <span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_setitem</span><span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_(index, value)</span>,
     and  <span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_getitem</span><span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_(index) </span>should  be  added  to  make  it  possible
     that   a   user   indexes   an   object   directly   like   <span 
class="cmtt-10x-x-109">tabcol[i]  </span>or
     <span 
class="cmtt-10x-x-109">tabcol[start:stop:step]</span>.
     </li>
     <li class="itemize">When  these  functions  are  added,  Python  supports  iteration  in
     an  object.  Explicit  iteration  can  also  be  done  by  adding  the
                                                                     

                                                                     
     functions  <span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_iter</span><span 
class="cmtt-10x-x-109">_</span><span 
class="cmtt-10x-x-109">_ </span>and  <span 
class="cmtt-10x-x-109">next</span>.  At  the  end  <span 
class="cmtt-10x-x-109">next </span>should  raise  the
     Python <span 
class="cmtt-10x-x-109">StopIteration </span>exception (or throw <span 
class="cmtt-10x-x-109">casa::IterError </span>when
     implemented in C++) to stop the iteration.</li></ul>
<!--l. 237--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">5   </span> <a 
 id="x1-90005"></a>Building pyrap</h3>
<!--l. 238--><p class="noindent" >pyrap is part of the Casacore source tree and can be built as part of the
Casacore build. Work is underway to build it separately as a Python egg.
<br 
class="newline" />To build it in Casacore the following has to be added to the local makedefs:
</p>
     <ul class="itemize1">
     <li class="itemize">Definitions for PYTHON telling the Python locations.
     </li>
     <li class="itemize">Definitions for BOOST telling the Boost.Python locations.
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">AUXILIARY += pyrap</span></li></ul>
<!--l. 248--><p class="noindent" >When doing it this way, pyrap is built with support for numarray. In order to build
it with support for numpy as well, the following has to be added to the local
makedefs:
                                                                     

                                                                     
</p>
   <div class="verbatim" id="verbatim-5">
PYTHONINCD&#x00A0;+=&#x00A0;&#8217;the&#x00A0;path&#x00A0;where&#x00A0;numpy/arrayobject.h&#x00A0;can&#x00A0;be&#x00A0;found&#8217;
&#x00A0;<br />PYTHONDEFS&#x00A0;+=&#x00A0;-DAIPS_USENUMPY
</div>
<!--l. 254--><p class="nopar" > If only numpy should be supported, the last line should be replaced
by:
                                                                     

                                                                     
</p>
   <div class="verbatim" id="verbatim-6">
PYTHONDEFS&#x00A0;:=&#x00A0;-DAIPS_USENUMPY
</div>
<!--l. 258--><p class="nopar" > When building pyrap, it is by default built as the shared library <span 
class="cmtt-10x-x-109">libpyrap.so</span>
containing the various converters and associated Casacore code. It can be built as
a static library by adding the appropriate <span 
class="cmtt-10x-x-109">LIBpyrap </span>line to the local makedefs.
However, it is strongly advised to build it as a shared library because:
</p>
     <ul class="itemize1">
     <li class="itemize">If  multiple  python  packages  are  used,  each  of  them  registers  the
     converters  in  Boost.Python.  If  the  same  converter  is  multiply
     registered, Boost.Python gives a warning. To avoid these warnings
     pyrap keeps a map of registered converters. It is clear that this map is
     only useful (i.e. shared between python packages) if pyrap is built as
     a shared library.
     </li>
     <li class="itemize">Multiple python packages share the converter code, thus reducing the
     memory footprint.</li></ul>
<!--l. 276--><p class="indent" >   A package <span 
class="cmtt-10x-x-109">pyxx </span>is built as a shared library <span 
class="cmtt-10x-x-109">_pyxx.so </span>residing in directory
$AIPSPATH/python$PYTHONVERSION/pyxx. All .py files are also put in this
directory and compiled to .pyo and .pyc files.
</p><!--l. 281--><p class="indent" >   On Mac OS-X Python libraries have to be built as bundles. For this the local
makedefs need to set some make variables:
                                                                     

                                                                     
</p>
   <div class="verbatim" id="verbatim-7">
PYLDSOPTS&#x00A0;&#x00A0;:=&#x00A0;-bundle
&#x00A0;<br />PYSFXSHAR&#x00A0;&#x00A0;:=&#x00A0;so
&#x00A0;<br />SFXSHAR&#x00A0;&#x00A0;&#x00A0;&#x00A0;:=&#x00A0;dylib
&#x00A0;<br />LDSOPTS&#x00A0;&#x00A0;&#x00A0;&#x00A0;:=&#x00A0;-dynamiclib&#x00A0;-single_module
&#x00A0;<br />PYTHONLIBS&#x00A0;:=&#x00A0;-framework&#x00A0;Python
</div>
<!--l. 289--><p class="nopar" > </p> 
</body></html> 

                                                                     


