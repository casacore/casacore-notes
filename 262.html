<?xml version="1.0" encoding="utf-8" ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" 
"http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd" > 
<html xmlns="http://www.w3.org/1999/xhtml"  
> 
<head><title>NOTE 262 – Casacore Testing Framework</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<!-- xhtml,mathml,fn-in,css-in,charset=utf-8,html --> 
<meta name="src" content="262.tex" /> 
 
<style type="text/css"> 
<!--  
 
/* start css.sty */  
.cmex-10{font-size:90%;}  
.cmr-10{font-size:90%;}  
.cmr-10x-x-109{}  
.cmbsy-10x-x-109{font-weight: bold;}  
.cmbsy-10x-x-109{font-weight: bold;}  
.cmbsy-10x-x-109{font-weight: bold;}  
.cmbsy-8{font-size:72%;font-weight: bold;}  
.cmbsy-8{font-weight: bold;}  
.cmbsy-8{font-weight: bold;}  
.cmbsy-6{font-size:54%;font-weight: bold;}  
.cmbsy-6{font-weight: bold;}  
.cmbsy-6{font-weight: bold;}  
.cmr-8{font-size:72%;}  
.cmr-6{font-size:54%;}  
.cmmi-10x-x-109{font-style: italic;}  
.cmmi-8{font-size:72%;font-style: italic;}  
.cmmi-6{font-size:54%;font-style: italic;}  
.cmsy-10x-x-109{}  
.cmsy-8{font-size:72%;}  
.cmsy-6{font-size:54%;}  
.cmr-17{font-size:154%;}  
.cmr-12{font-size:109%;}  
.cmbx-10{font-size:90%; font-weight: bold;}  
.cmtt-10x-x-109{font-family: monospace;}  
p.noindent { text-indent: 0em }  
td p.noindent { text-indent: 0em; margin-top:0em; }  
p.nopar { text-indent: 0em; }  
p.indent{ text-indent: 1.5em }  
@media print {div.crosslinks {visibility:hidden;}}  
a img { border-top: 0; border-left: 0; border-right: 0; }  
center { margin-top:1em; margin-bottom:1em; }  
td center { margin-top:0em; margin-bottom:0em; }  
.Canvas { position:relative; }  
math { text-indent: 0em; }  
li p.indent { text-indent: 0em }  
li p:first-child{ margin-top:0em; }  
li p:last-child, li div:last-child { margin-bottom:0.5em; }  
li p~ul:last-child, li p~ol:last-child{ margin-bottom:0.5em; }  
.enumerate1 {list-style-type:decimal;}  
.enumerate2 {list-style-type:lower-alpha;}  
.enumerate3 {list-style-type:lower-roman;}  
.enumerate4 {list-style-type:upper-alpha;}  
div.newtheorem { margin-bottom: 2em; margin-top: 2em;}  
.obeylines-h,.obeylines-v {white-space: nowrap; }  
div.obeylines-v p { margin-top:0; margin-bottom:0; }  
.overline{ text-decoration:overline; }  
.overline img{ border-top: 1px solid black; }  
td.displaylines {text-align:center; white-space:nowrap;}  
.centerline {text-align:center;}  
.rightline {text-align:right;}  
div.verbatim {font-family: monospace; white-space: nowrap; text-align:left; clear:both; }  
.fbox {padding-left:3.0pt; padding-right:3.0pt; text-indent:0pt; border:solid black 0.4pt; }  
div.fbox {display:table}  
div.center div.fbox {text-align:center; clear:both; padding-left:3.0pt; padding-right:3.0pt; text-indent:0pt; border:solid black 0.4pt; }  
div.minipage{width:100%;}  
div.center, div.center div.center {text-align: center; margin-left:1em; margin-right:1em;}  
div.center div {text-align: left;}  
div.flushright, div.flushright div.flushright {text-align: right;}  
div.flushright div {text-align: left;}  
div.flushleft {text-align: left;}  
.underline{ text-decoration:underline; }  
.underline img{ border-bottom: 1px solid black; margin-bottom:1pt; }  
.framebox-c, .framebox-l, .framebox-r { padding-left:3.0pt; padding-right:3.0pt; text-indent:0pt; border:solid black 0.4pt; }  
.framebox-c {text-align:center;}  
.framebox-l {text-align:left;}  
.framebox-r {text-align:right;}  
span.thank-mark{ vertical-align: super }  
span.footnote-mark sup.textsuperscript, span.footnote-mark a sup.textsuperscript{ font-size:80%; }  
div.footnotes{border-top:solid 1px black; border-bottom:solid 1px black; padding-bottom:1ex; padding-top:0.5ex; margin-right:15%; margin-top:2ex; font-style:italic; font-size:85%;}  
div.footnotes p{margin-top:0; margin-bottom:0; text-indent:0;}  
div.tabular, div.center div.tabular {text-align: center; margin-top:0.5em; margin-bottom:0.5em; }  
table.tabular td p{margin-top:0em;}  
table.tabular {margin-left: auto; margin-right: auto;}  
td p:first-child{ margin-top:0em; }  
td p:last-child{ margin-bottom:0em; }  
div.td00{ margin-left:0pt; margin-right:0pt; }  
div.td01{ margin-left:0pt; margin-right:5pt; }  
div.td10{ margin-left:5pt; margin-right:0pt; }  
div.td11{ margin-left:5pt; margin-right:5pt; }  
table[rules] {border-left:solid black 0.4pt; border-right:solid black 0.4pt; }  
td.td00{ padding-left:0pt; padding-right:0pt; }  
td.td01{ padding-left:0pt; padding-right:5pt; }  
td.td10{ padding-left:5pt; padding-right:0pt; }  
td.td11{ padding-left:5pt; padding-right:5pt; }  
table[rules] {border-left:solid black 0.4pt; border-right:solid black 0.4pt; }  
.hline hr, .cline hr{ height : 1px; margin:0px; }  
.tabbing-right {text-align:right;}  
span.TEX {letter-spacing: -0.125em; }  
span.TEX span.E{ position:relative;top:0.5ex;left:-0.0417em;}  
a span.TEX span.E {text-decoration: none; }  
span.LATEX span.A{ position:relative; top:-0.5ex; left:-0.4em; font-size:85%;}  
span.LATEX span.TEX{ position:relative; left: -0.4em; }  
div.float, div.figure {margin-left: auto; margin-right: auto;}  
div.float img {text-align:center;}  
div.figure img {text-align:center;}  
.marginpar {width:20%; float:right; text-align:left; margin-left:auto; margin-top:0.5em; font-size:85%; text-decoration:underline;}  
.marginpar p{margin-top:0.4em; margin-bottom:0.4em;}  
.equation td{text-align:center; vertical-align:middle; }  
td.eq-no{ width:5%; }  
table.equation { width:100%; }  
div.math-display, div.par-math-display{text-align:center;}  
mtr.hline mtd{ border-bottom:black solid 1px; padding-top:2px; padding-bottom:0em; }  
mtr.hline mtd mo{ display:none }  
math .texttt { font-family: monospace; }  
math .textit { font-style: italic; }  
math .textsl { font-style: oblique; }  
math .textsf { font-family: sans-serif; }  
math .textbf { font-weight: bold; }  
mo.MathClass-op + mi{margin-left:0.3em}  
mi + mo.MathClass-op{margin-left:0.3em}  
math mi[mathvariant="bold"] { font-weight: bold; font-style: normal; }  
math mi[mathvariant="normal"] { font-weight: normal; font-style: normal; }  
.partToc a, .partToc, .likepartToc a, .likepartToc {line-height: 200%; font-weight:bold; font-size:110%;}  
.index-item, .index-subitem, .index-subsubitem {display:block}  
div.caption {text-indent:-2em; margin-left:3em; margin-right:1em; text-align:left;}  
div.caption span.id{font-weight: bold; white-space: nowrap; }  
h1.partHead{text-align: center}  
p.bibitem { text-indent: -2em; margin-left: 2em; margin-top:0.6em; margin-bottom:0.6em; }  
p.bibitem-p { text-indent: 0em; margin-left: 2em; margin-top:0.6em; margin-bottom:0.6em; }  
.paragraphHead, .likeparagraphHead { margin-top:2em; font-weight: bold;}  
.subparagraphHead, .likesubparagraphHead { font-weight: bold;}  
.quote {margin-bottom:0.25em; margin-top:0.25em; margin-left:1em; margin-right:1em; text-align:justify;}  
.verse{white-space:nowrap; margin-left:2em}  
div.maketitle {text-align:center;}  
h2.titleHead{text-align:center;}  
div.maketitle{ margin-bottom: 2em; }  
div.author, div.date {text-align:center;}  
div.thanks{text-align:left; margin-left:10%; font-size:85%; font-style:italic; }  
.quotation {margin-bottom:0.25em; margin-top:0.25em; margin-left:1em; }  
.abstract p {margin-left:5%; margin-right:5%;}  
div.abstract {width:100%;}  
/* end css.sty */  
 
 
--> 
</style> 
</head><body 
>
   <div class="maketitle">
                                                                                         

                                                                                         
                                                                                         

                                                                                         

<h2 class="titleHead">NOTE 262 – Casacore Testing Framework</h2>
<div class="author" ><span 
class="cmr-12">Ger van Diepen, ASTRON Dwingeloo</span></div><br />
<div class="date" ><span 
class="cmr-12">2013 Aug 21</span></div>
   </div><div 
class="abstract" 
>
<div class="center" 
>
<!--l. 22--><p class="noindent" >
</p><!--l. 22--><p class="noindent" ><span 
class="cmbx-10">Abstract</span></p></div>
     <!--l. 23--><p class="indent" >    <span 
class="cmr-10">Casacore has an advanced testing framework on top of the CMake environment. It makes it</span>
     <span 
class="cmr-10">possible to do regression testing, coverage testing, and use tools like valgrind in an automatic</span>
     <span 
class="cmr-10">way.</span>
</p>
</div> <a 
href="262.pdf" >A pdf version of this note is available.</a>
   <h3 class="likesectionHead"><a 
 id="x1-1000"></a>Contents</h3>
   <div class="tableofcontents">
   <span class="sectionToc" >1 <a 
href="#x1-20001" id="QQ2-1-2">Introduction</a></span>
<br />   <span class="sectionToc" >2 <a 
href="#x1-30002" id="QQ2-1-3">Casacore build system</a></span>
<br />    <span class="subsectionToc" >2.1 <a 
href="#x1-40002.1" id="QQ2-1-4">Source code structure</a></span>
<br />    <span class="subsectionToc" >2.2 <a 
href="#x1-50002.2" id="QQ2-1-5">Build directory structure</a></span>
<br />   <span class="sectionToc" >3 <a 
href="#x1-60003" id="QQ2-1-6">Creating a test</a></span>
<br />   <span class="sectionToc" >4 <a 
href="#x1-70004" id="QQ2-1-7">Running tests</a></span>
<br />    <span class="subsectionToc" >4.1 <a 
href="#x1-80004.1" id="QQ2-1-8">Return status</a></span>
<br />   <span class="sectionToc" >5 <a 
href="#x1-90005" id="QQ2-1-9">Valgrind support</a></span>
<br />    <span class="subsectionToc" >5.1 <a 
href="#x1-100005.1" id="QQ2-1-10">Using other checking tools</a></span>
<br />    <span class="subsectionToc" >5.2 <a 
href="#x1-110005.2" id="QQ2-1-11">Omitting tests in check tool</a></span>
<br />   <span class="sectionToc" >6 <a 
href="#x1-120006" id="QQ2-1-12">Test coverage support</a></span>
   </div>
                                                                                         

                                                                                         
   <h3 class="sectionHead"><span class="titlemark">1   </span> <a 
 id="x1-20001"></a>Introduction</h3>
<!--l. 37--><p class="noindent" >Casacore comes with an extensive set of test programs. The tests can be built in the cmake environment
used by casacore by adding <span 
class="cmtt-10x-x-109">-DBUILD</span><span 
class="cmtt-10x-x-109">_TESTING=ON </span>to the <span 
class="cmtt-10x-x-109">cmake </span>command. Running the tests can be done
using the <span 
class="cmtt-10x-x-109">make test </span>or <span 
class="cmtt-10x-x-109">ctest </span>command. For regression testing purposes the standard output of a test run
can be compared with the expected output. Casacore uses a few scripts doing the actual execution of a
test.
</p><!--l. 47--><p class="indent" >   A test can be embedded in a script for optional preprocessing or postprocessing of a test or to run a
test in multiple ways. <br 
class="newline" />Such a script can also be used to test an application (such as <span 
class="cmtt-10x-x-109">taql</span>).
</p><!--l. 51--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">2   </span> <a 
 id="x1-30002"></a>Casacore build system</h3>
<!--l. 52--><p class="noindent" >Casacore uses the cmake system to build the code and test programs. ctest is used to execute the test
programs and to check for success or failure.
</p><!--l. 56--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">2.1   </span> <a 
 id="x1-40002.1"></a>Source code structure</h4>
<!--l. 57--><p class="noindent" >The casacore source code is divided into modules (e.g. casa, tables). Each module is divided into packages
(e.g. casa/IO) containing the source ﬁles. Each package should have a test directory containing the test
programs. Schematically it is organized like:
                                                                                         

                                                                                         
</p>
   <div class="verbatim" id="verbatim-1">
  casacore
 <br />    module1        #
 <br />      package1
 <br />        X.h
 <br />        X.cc
 <br />        test
 <br />          tX.cc
</div>
<!--l. 69--><p class="nopar" > The build system creates a library per module (e.g. <span 
class="cmtt-10x-x-109">libcasa</span><span 
class="cmtt-10x-x-109">_tables</span>). Modules are layered,
thus the libraries not mutually dependent. Packages in a module can use each other, also
mutually.
</p><!--l. 75--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">2.2   </span> <a 
 id="x1-50002.2"></a>Build directory structure</h4>
<!--l. 76--><p class="noindent" >It is best to build casacore in a <span 
class="cmtt-10x-x-109">build </span>directory at the same level as the <span 
class="cmtt-10x-x-109">casacore </span>directory. In this way
the source and build ﬁles are well separated.
</p><!--l. 80--><p class="indent" >   The code can be built in various ways (optimized, debug, etc.), so in the build directory a directory
should be created telling the build type. The build system makes uses of the name to automatically set
the compile options for a build type. It recognizes: </p>
     <ul class="itemize1">
     <li class="itemize"><span 
class="cmtt-10x-x-109">dbg </span>or <span 
class="cmtt-10x-x-109">debug </span>deﬁning a debug build (sets <span 
class="cmtt-10x-x-109">-O0 -g</span>).
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">cov </span>deﬁning a coverage build (sets <span 
class="cmtt-10x-x-109">--coverage</span>).
     </li>
     <li class="itemize">Any other name deﬁnes an optimized build (sets <span 
class="cmtt-10x-x-109">-O3</span>).</li></ul>
<!--l. 89--><p class="noindent" >In this directory the source code structure is mirrored, thus it will have directories like <span 
class="cmtt-10x-x-109">casa/IO/test</span>.
</p><!--l. 92--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">3   </span> <a 
 id="x1-60003"></a>Creating a test</h3>
<!--l. 93--><p class="noindent" >Casacore consists of several modules (e.g. <span 
class="cmtt-10x-x-109">scimath</span>, <span 
class="cmtt-10x-x-109">tables</span>). A module can consist of one or more
packages (e.g. <span 
class="cmtt-10x-x-109">casa/IO</span>, <span 
class="cmtt-10x-x-109">casa/OS</span>). Each package contains one or more classes, usually one class per ﬁle.
Test programs should be created in the <span 
class="cmtt-10x-x-109">test </span>directory of a package.
                                                                                         

                                                                                         
</p><!--l. 100--><p class="indent" >   Usually a test for class X is written in C++. The casacore convention is to name such a test tX,
thus the source code for a test is in <span 
class="cmtt-10x-x-109">&#x003C;module&#x003E;/&#x003C;package&#x003E;/test/tX.cc</span>. In order to build the
test program, it needs to be added to the <span 
class="cmtt-10x-x-109">tests </span>list in the <span 
class="cmtt-10x-x-109">CMakeLists.txt </span>ﬁle in that test
directory.
</p><!--l. 108--><p class="indent" >   The test executable is created in the build directory <span 
class="cmtt-10x-x-109">build/&#x003C;type&#x003E;/&#x003C;module&#x003E;/&#x003C;package&#x003E;/test</span>.
</p><!--l. 111--><p class="indent" >   Besides the .cc ﬁle, a few more ﬁles can be created for a test. They also need to reside in the source
test directory. When using a standard name as in the list below, they will be copied automatically to the
build test directory when the test is run. </p>
     <ul class="itemize1">
     <li class="itemize"><span 
class="cmtt-10x-x-109">tX.run </span>is a script. It can contain commands to do some preprocessing, postprocessing, to run
     the test in diﬀerent ways, etc. Note that such a script is usually a shell script, but could also
     be a python script or any other executable script. If the script is not executable, it is run
     through <span 
class="cmtt-10x-x-109">sh</span>. <br 
class="newline" />Note that the invocation of the test program in a script should in principle be preceeded by
     <span 
class="cmtt-10x-x-109">$casa</span><span 
class="cmtt-10x-x-109">_checktool</span>. This environment variable deﬁnes an optional check tool (like valgrind)
     as described in a next section. <br 
class="newline" />Also note that in a script a test program should be run as <span 
class="cmtt-10x-x-109">./tX</span>, because . does not need to
     be part of the PATH.
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">tX.in </span>is a text ﬁle giving test input lines. If existing, the standard input of the test program
     (or script) is redirected to this ﬁle.
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">tX.out </span>is a text ﬁle containing the expected standard output of the test. It is very useful for
     regression testing. The next section discusses how it is used.
     </li>
     <li class="itemize"><span 
class="cmtt-10x-x-109">tX.in</span><span 
class="cmtt-10x-x-109">_* </span>are other inputs that can be used by the test. They can be simple ﬁles, but also
     tar-ﬁles (which can be unpacked in the .run ﬁle) or directories (e.g., casacore tables).</li></ul>
<!--l. 139--><p class="noindent" >Note that to run test tX, the test system will only copy ﬁles/directories as named above to the build test
directory. After the test they will be removed from the build test directory. If test input ﬁles are named
diﬀerently, they can be used in one of the two following ways.
</p>
     <ul class="itemize1">
     <li class="itemize">For each test the test system deﬁnes the environment variable <span 
class="cmtt-10x-x-109">testsrcdir </span>as the source
     directory of that test. It can be used in test programs or scripts to copy a test ﬁle from the
     test source directory or to use it directly. If using it directly, it should (of course) be used
     readonly.
     </li>
     <li class="itemize">Another option to copy ﬁles from the source to the working directory is by adding appropriate lines
     to <span 
class="cmtt-10x-x-109">test/CMakeLists.txt </span>like:
                                                                                         

                                                                                         
     <div class="verbatim" id="verbatim-2">
     set (datafiles
      <br />amp_0.fits
      <br />ampErr_0.fits
      <br />)
      <br />foreach (file ${datafiles})
      <br />    configure_file (${CMAKE_CURRENT_SOURCE_DIR}/${file} ${CMAKE_CURRENT_BINARY_DIR}/${file} COPYONLY)
      <br />endforeach (file)
</div>
     <!--l. 163--><p class="nopar" > to let the cmake system copy the ﬁle to the working directory. An entire directory cannot be done
     in a single line; each individual ﬁle has to be named.</p></li></ul>
<!--l. 169--><p class="indent" >   If the test program or script creates output ﬁles, it is best to call them <span 
class="cmtt-10x-x-109">tX</span><span 
class="cmtt-10x-x-109">_tmp&#x003C;something&#x003E;</span>. In this
way they will be removed automatically after the test is run.
</p><!--l. 173--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">4   </span> <a 
 id="x1-70004"></a>Running tests</h3>
<!--l. 174--><p class="noindent" >The standard way to run a test is using <span 
class="cmtt-10x-x-109">ctest</span>. It makes it possible to run all or some tests.
                                                                                         

                                                                                         
</p>
   <div class="verbatim" id="verbatim-3">
ctest                    # all tests
 <br />ctest -R tArray          # only tests matching *tArray*
 <br />ctest -E tArray          # exclude tests matching *tArray*
</div>
<!--l. 180--><p class="nopar" > If such a command is run in the casacore top build directory, all casacore tests are considered. However,
it is also possible to run it in a subdirectory (e.g. casa or casa/IO/test) to execute only tests of a speciﬁc
module or package.
</p><!--l. 186--><p class="indent" >   The system runs a test as follows:
     </p><ol  class="enumerate1" >
     <li 
  class="enumerate" id="x1-7002x1"><span 
class="cmtt-10x-x-109">ctest </span>starts the script <span 
class="cmtt-10x-x-109">cmake</span><span 
class="cmtt-10x-x-109">_assay </span>to run the test.
     </li>
     <li 
  class="enumerate" id="x1-7004x2"><span 
class="cmtt-10x-x-109">cmake</span><span 
class="cmtt-10x-x-109">_assay </span>copies the tX ﬁles mentioned in the previous section to the build test directory
     where the test is run. Thereafter it starts <span 
class="cmtt-10x-x-109">casacore</span><span 
class="cmtt-10x-x-109">_assay </span>to run the actual test.
     </li>
     <li 
  class="enumerate" id="x1-7006x3"><span 
class="cmtt-10x-x-109">casacore</span><span 
class="cmtt-10x-x-109">_assay </span>executes the test as follows:
          <ul class="itemize1">
          <li class="itemize">If <span 
class="cmtt-10x-x-109">tX.run </span>exists, that script will be executed. otherwise <span 
class="cmtt-10x-x-109">tX </span>itself.
          </li>
          <li class="itemize">If <span 
class="cmtt-10x-x-109">tX.in </span>exists, it will be redirected as input to tX.
          </li>
          <li class="itemize">If <span 
class="cmtt-10x-x-109">tX.out </span>exists, it will be compared with the standard output of the test. The comparison is
          not done if the test exits with an error status. Before the comparison is done the output is
          massaged as follows to cater for system speciﬁc output.
              <ul class="itemize2">
              <li class="itemize">The working directory is removed from the test output.
              </li>
              <li class="itemize">Text enclosed in <span 
class="cmtt-10x-x-109">&#x003E;&#x003E;&#x003E; </span>and <span 
class="cmtt-10x-x-109">&#x003C;&#x003C;&#x003C; </span>on a single line is removed from the test output and
              the expected output.
              </li>
              <li class="itemize">Text demarked by lines starting with <span 
class="cmtt-10x-x-109">&#x003E;&#x003E;&#x003E; </span>and <span 
class="cmtt-10x-x-109">&#x003C;&#x003C;&#x003C; </span>is removed from the test output
              and the expected output.
              </li>
              <li class="itemize">If a diﬀ of the resulting test output and expected output ﬁnds no diﬀerences, the
              test passes. If any non-numerical value mismatches, the test fails.
              </li>
              <li class="itemize">Otherwise <span 
class="cmtt-10x-x-109">casacore</span><span 
class="cmtt-10x-x-109">_floatcheck </span>is run to compare all numerical values with a
              relative error margin of 10e-5. The test fails if a value is found unequal.</li></ul>
                                                                                         

                                                                                         
          </li>
          <li class="itemize">At the end of the test the <span 
class="cmtt-10x-x-109">tX</span><span 
class="cmtt-10x-x-109">_tmp* </span>ﬁles/directories and the copied tX ﬁles are removed by
          <span 
class="cmtt-10x-x-109">casacore</span><span 
class="cmtt-10x-x-109">_assay</span>.</li></ul>
     </li></ol>
<!--l. 219--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">4.1   </span> <a 
 id="x1-80004.1"></a>Return status</h4>
<!--l. 220--><p class="noindent" >The return of a test program or script can be: <br 
class="newline" />- 0 indicating success. <br 
class="newline" />- 3 indicating that the test is skipped. This might be used if an expected input ﬁle is not available or if the
test is run on a platform not supporting it. <span 
class="cmtt-10x-x-109">cmake</span><span 
class="cmtt-10x-x-109">_assay </span>will change this to 0, because ctest can only deal
with success and failure. <br 
class="newline" />- Any other value indicates a failure.
</p><!--l. 229--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">5   </span> <a 
 id="x1-90005"></a>Valgrind support</h3>
<!--l. 230--><p class="noindent" >If the environment variable CASACORE_CHECK has the value 1, the <span 
class="cmtt-10x-x-109">casacore</span><span 
class="cmtt-10x-x-109">_assay </span>script runs the
test of an executable through <span 
class="cmtt-10x-x-109">casacore</span><span 
class="cmtt-10x-x-109">_memcheck</span>. This script runs the test through valgrind’s memcheck
tool and tests for errors, deﬁnite and possible leaks, and leaked ﬁle descriptors. If any such
problem is found, the valgrind output is put into a ﬁle <span 
class="cmtt-10x-x-109">tX.checktool.valgrind </span>in the working
directory.
</p><!--l. 237--><p class="indent" >   If a .run ﬁle is used to execute the test, each invocation of the test program in the .run ﬁle should be
preceeded by <span 
class="cmtt-10x-x-109">$casa</span><span 
class="cmtt-10x-x-109">_checktool</span>. This environment variable deﬁnes the valgrind command. If valgrind is
not used, the variable is empty.
</p><!--l. 242--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">5.1   </span> <a 
 id="x1-100005.1"></a>Using other checking tools</h4>
<!--l. 243--><p class="noindent" >The same mechanism can be used to use a check tool diﬀerent from valgrind’s memcheck.
<br 
class="newline" />CASACORE_CHECK can be deﬁned as the name of a script or a command to use. In fact, deﬁning
CASACORE_CHECK as <span 
class="cmtt-10x-x-109">casacore</span><span 
class="cmtt-10x-x-109">_memcheck </span>would have the same eﬀect as deﬁning it as
1.
</p><!--l. 249--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">5.2   </span> <a 
 id="x1-110005.2"></a>Omitting tests in check tool</h4>
                                                                                         

                                                                                         
<!--l. 250--><p class="noindent" >Sometimes a test run with a check tool can take too much time and should be omitted. There is no direct
way to tell that a speciﬁc test should be omitted. However, it can easily be achieved by having a .run ﬁle
for such a test without the <span 
class="cmtt-10x-x-109">$casa</span><span 
class="cmtt-10x-x-109">_checktool </span>preﬁx.
</p><!--l. 256--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">6   </span> <a 
 id="x1-120006"></a>Test coverage support</h3>
<!--l. 257--><p class="noindent" >The casacore build system has support for test coverage analysis. By building in the directory <span 
class="cmtt-10x-x-109">build/cov</span>
the code is automatically built this way. Currently, only the g++ compiler is supported. Support for clang
will be added later. <br 
class="newline" />The script <span 
class="cmtt-10x-x-109">casacore</span><span 
class="cmtt-10x-x-109">_cov </span>(in casacore/scons-tools) should be used to run the tests, analyze the test
output, and generate coverage reports from it using <span 
class="cmtt-10x-x-109">lcov </span>and <span 
class="cmtt-10x-x-109">genhtml</span>. It works as follows:
</p>
     <ul class="itemize1">
     <li class="itemize">The coverage counters are initialized.
     </li>
     <li class="itemize">All tests are run using <span 
class="cmtt-10x-x-109">ctest</span>.
     </li>
     <li class="itemize">Coverage results are assembled with <span 
class="cmtt-10x-x-109">lcov </span>and converted to nice html pages using <span 
class="cmtt-10x-x-109">genhtml</span>.
     The root page is ./cov/index.html.
     </li>
     <li class="itemize">Both code and branch coverage info is generated for the module code, thus test program code
     is removed. Function coverage info is not generated, because the tools cannot cope well with
     functions automatically generated by the compiler.
     </li>
     <li class="itemize">The ﬁle <span 
class="cmtt-10x-x-109">testcov.log </span>contains a log of the script’s output.
     </li>
     <li class="itemize">The script can be run at various levels.
          <ul class="itemize2">
          <li class="itemize">If run in build/cov it will run all tests and generate test coverage for all modules.
          </li>
          <li class="itemize">If run in e.g. build/cov/casa, it will generate test coverage for module casa.
          </li>
          <li class="itemize">If run in e.g. build/cov/casa/IO/test, it will generate test coverage for package IO of
          module casa.</li></ul>
     </li></ul>
    
</body></html> 

                                                                                         


